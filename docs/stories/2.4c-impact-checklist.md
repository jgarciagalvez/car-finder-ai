# Story 2.4c Impact Checklist

**Generated:** 2025-10-14
**Purpose:** Track all documentation and code updates required due to Story 2.4c fixes

---

## Executive Summary

Story 2.4c introduced:
1. **New API Endpoints:** POST /vehicles/:id/translate and /analyze for on-demand operations
2. **New Vehicle Status:** `'not_interested'` added to VehicleStatus enum
3. **Pipeline Architecture Change:** Translation now happens BEFORE analysis (two-step workflow)
4. **Feature Filtering Logic:** Vehicles filtered by `sourceEquipment` (Polish) BEFORE translation

---

## ðŸ“‹ Documentation Changes Required

### 1. Story 2.5 (Card-Based Vehicle Dashboard)

**File:** `docs/stories/2.5.story.md`

#### âœ… Line 27 - Status Badge Update
- [x] **Current:** `Add status badge indicator (new, to_contact, contacted, to_visit, visited, deleted)`
- [x] **Update To:** `Add status badge indicator (new, to_contact, contacted, to_visit, visited, not_interested, deleted)`

#### âœ… Line 42 - Add New Task Section (INSERT AFTER)
```markdown
- [ ] Add vehicle action buttons to VehicleCard component (AC: 2)
  - [ ] Create "Force Translate" button that calls POST /api/vehicles/:id/translate?force=true
  - [ ] Create "Force Analyze" button that calls POST /api/vehicles/:id/analyze?force=true
  - [ ] Display buttons only for vehicles with status='not_interested' or missing AI data
  - [ ] Show loading state during API call (spinner on button)
  - [ ] Handle success: Update vehicle in context with returned data
  - [ ] Handle errors: Display error message to user (toast notification)
  - [ ] Add confirmation dialog before forcing operations
  - [ ] Style buttons appropriately (secondary/ghost style, small size)
  - [ ] Add tooltips explaining what each button does
  - [ ] Ensure buttons are keyboard accessible
```

#### âœ… After Line 47 - Add API Client Task Section (INSERT)
```markdown
- [ ] Add API client functions for vehicle operations (AC: 2)
  - [ ] Add translateVehicle(vehicleId: string, force?: boolean): Promise<Vehicle>
  - [ ] Add analyzeVehicle(vehicleId: string, force?: boolean): Promise<Vehicle>
  - [ ] Both functions should POST to respective endpoints
  - [ ] Include proper error handling and HTTP status code checks
  - [ ] Return parsed Vehicle object from response
  - [ ] Add TypeScript types for request/response
```

#### âœ… Context Enhancement Task (INSERT)
```markdown
- [ ] Enhance VehicleContext with action functions (AC: 2)
  - [ ] Add forceTranslateVehicle(vehicleId: string): Promise<void>
  - [ ] Add forceAnalyzeVehicle(vehicleId: string): Promise<void>
  - [ ] Both functions should call API client and update vehicles array
  - [ ] Handle loading state during operations
  - [ ] Handle error state and surface to UI
  - [ ] Emit events for success/failure (for toast notifications)
```

#### âœ… Line 48-56 - Update Test Requirements
**Add these test cases:**
- [ ] Unit tests for action buttons (Force Translate, Force Analyze)
- [ ] Test button visibility based on vehicle status and AI data
- [ ] Test loading states during API calls
- [ ] Test error handling for failed API calls
- [ ] Test translateVehicle() and analyzeVehicle() API client functions
- [ ] Test VehicleContext action functions

#### âœ… Line 258 - Add API Integration Section (INSERT AFTER)
```markdown
#### Vehicle Operations API [Source: Story 2.4c lines 489-520]

**POST /api/vehicles/:id/translate Endpoint**:
- **URL**: `http://localhost:3000/api/vehicles/:id/translate?force=true`
- **Method**: POST
- **Query Parameters**:
  - `force` (optional): boolean - If true, re-translate even if already translated
- **Response**: 202 Accepted with updated Vehicle JSON
- **Error Codes**: 404 Not Found, 500 Server Error
- **Use Case**: Force re-translation of a vehicle (e.g., if translation was incomplete or 'not_interested' status needs reversal)

**POST /api/vehicles/:id/analyze Endpoint**:
- **URL**: `http://localhost:3000/api/vehicles/:id/analyze?force=true`
- **Method**: POST
- **Query Parameters**:
  - `force` (optional): boolean - If true, re-analyze all steps
- **Response**: 202 Accepted with updated Vehicle JSON
- **Error Codes**: 404 Not Found, 500 Server Error
- **Use Case**: Force re-analysis of a vehicle (e.g., after user updates criteria or if analysis incomplete)

**Frontend Integration Pattern**:
\`\`\`typescript
// In lib/api.ts
export async function translateVehicle(vehicleId: string, force: boolean = false): Promise<Vehicle> {
  const url = \`\${API_BASE_URL}/vehicles/\${vehicleId}/translate\${force ? '?force=true' : ''}\`;
  const response = await fetch(url, { method: 'POST' });

  if (!response.ok) {
    if (response.status === 404) throw new Error('Vehicle not found');
    throw new Error('Translation failed');
  }

  return await response.json();
}

export async function analyzeVehicle(vehicleId: string, force: boolean = false): Promise<Vehicle> {
  const url = \`\${API_BASE_URL}/vehicles/\${vehicleId}/analyze\${force ? '?force=true' : ''}\`;
  const response = await fetch(url, { method: 'POST' });

  if (!response.ok) {
    if (response.status === 404) throw new Error('Vehicle not found');
    throw new Error('Analysis failed');
  }

  return await response.json();
}
\`\`\`

**UI Integration Example** (VehicleCard component):
\`\`\`tsx
import { useVehicles } from '@/context/VehicleContext';
import { translateVehicle, analyzeVehicle } from '@/lib/api';

function VehicleCard({ vehicle }: VehicleCardProps) {
  const { updateVehicle } = useVehicles();
  const [isTranslating, setIsTranslating] = useState(false);
  const [isAnalyzing, setIsAnalyzing] = useState(false);

  const handleForceTranslate = async () => {
    if (!confirm('Force re-translate this vehicle? This will use AI credits.')) return;

    try {
      setIsTranslating(true);
      const updatedVehicle = await translateVehicle(vehicle.id, true);
      updateVehicle(updatedVehicle);
      toast.success('Vehicle translated successfully');
    } catch (error) {
      toast.error('Translation failed: ' + error.message);
    } finally {
      setIsTranslating(false);
    }
  };

  const handleForceAnalyze = async () => {
    if (!confirm('Force re-analyze this vehicle? This will use AI credits.')) return;

    try {
      setIsAnalyzing(true);
      const updatedVehicle = await analyzeVehicle(vehicle.id, true);
      updateVehicle(updatedVehicle);
      toast.success('Vehicle analyzed successfully');
    } catch (error) {
      toast.error('Analysis failed: ' + error.message);
    } finally {
      setIsAnalyzing(false);
    }
  };

  // Show action buttons for not_interested or incomplete AI data
  const showActions = vehicle.status === 'not_interested' ||
                      !vehicle.description ||
                      !vehicle.aiPriorityRating;

  return (
    <div className="vehicle-card">
      {/* ... existing card content ... */}

      {showActions && (
        <div className="card-actions">
          <Button
            size="sm"
            variant="ghost"
            onClick={handleForceTranslate}
            disabled={isTranslating}
          >
            {isTranslating ? 'Translating...' : 'Force Translate'}
          </Button>
          <Button
            size="sm"
            variant="ghost"
            onClick={handleForceAnalyze}
            disabled={isAnalyzing}
          >
            {isAnalyzing ? 'Analyzing...' : 'Force Analyze'}
          </Button>
        </div>
      )}
    </div>
  );
}
\`\`\`
```

#### âœ… Line 299 - Update VehicleCard Test Requirements
**Update test case:**
- [x] **Current:** `Test status badge rendering for all VehicleStatus values`
- [x] **Update To:** `Test status badge rendering for all VehicleStatus values (including 'not_interested')`

---

### 2. Architecture Documentation

#### ðŸ“„ data-models.md

**File:** `docs/architecture/data-models.md`

- [ ] **Line 12** - Update VehicleStatus enum
  ```typescript
  // CURRENT:
  export type VehicleStatus = 'new' | 'to_contact' | 'contacted' | 'to_visit' | 'visited' | 'deleted';

  // UPDATE TO:
  export type VehicleStatus = 'new' | 'to_contact' | 'contacted' | 'to_visit' | 'visited' | 'not_interested' | 'deleted';
  ```

- [ ] **After Line 68** - Add Note About not_interested Status
  ```markdown
  **Status Field Notes:**
  - `'not_interested'`: Vehicle automatically filtered out during translation due to missing required features (see Story 2.4c). Can be manually re-translated via UI action button with force flag.
  ```

---

#### ðŸ“„ core-workflows.md

**File:** `docs/architecture/core-workflows.md`

- [ ] **Line 50** - INSERT NEW WORKFLOW SECTION (before "AI Analysis Workflow")
  ```markdown
  ## 2. Translation & Filtering Workflow

  The translation pipeline processes vehicles with NULL description/features fields, filtering out vehicles that don't meet required feature criteria BEFORE calling AI.

  \`\`\`mermaid
  sequenceDiagram
      participant Script as translate.ts
      participant Config as search-config.json
      participant Repo as VehicleRepository
      participant AI as AIService<br/>(packages/ai)
      participant Gemini as Gemini API (Flash-Lite)
      participant DB as SQLite Database

      Script->>Config: Load translationModel & requiredFeatures
      Script->>Repo: findVehiclesNeedingTranslation()
      Repo-->>Script: Vehicles with NULL description/features

      loop For each vehicle
          Script->>Script: Parse sourceEquipment (Polish JSON)
          Script->>Script: hasRequiredFeatures() check

          alt Has required features OR --force flag
              Script->>AI: translateVehicleContent(vehicle)
              AI->>Gemini: Translation prompt (Polish â†’ English)
              Gemini-->>AI: Translated description + features
              Script->>Repo: updateVehicle(description, features)
              Repo->>DB: UPDATE vehicle
          else Missing ALL required features
              Script->>Repo: updateVehicle(status='not_interested', aiDataSanityCheck)
              Repo->>DB: UPDATE vehicle (filtered out)
          end

          Script->>Script: Rate limit delay (4s)
      end
  \`\`\`

  **Key Points:**
  - Feature filtering happens BEFORE translation (saves API costs)
  - Uses \`sourceEquipment\` (Polish) for matching, not translated \`features\`
  - Filtered vehicles marked as \`'not_interested'\` status
  - Uses faster model (gemini-2.5-flash-lite) vs analysis model
  - Respects 15 RPM rate limit (4s delay)
  - \`--force\` flag bypasses filter for manual override
  - UI can trigger re-translation via POST /api/vehicles/:id/translate?force=true
  ```

- [ ] **Line 63** - Update Existing "AI Analysis Workflow" Section Title
  **Change:** `## 2. AI Analysis Workflow` â†’ `## 3. AI Analysis Workflow`

- [ ] **Line 63** - Add Note After Title
  ```markdown
  ## 3. AI Analysis Workflow

  **Note:** This workflow assumes vehicles are pre-translated via translate.ts (Step 2 above). Analysis pipeline no longer includes translation.
  ```

- [ ] **Line 97** - Update Existing "AI Chat Interaction Workflow" Section Title
  **Change:** `## 3. AI Chat Interaction Workflow` â†’ `## 4. AI Chat Interaction Workflow`

---

#### ðŸ“„ api-specification.md

**File:** `docs/architecture/api-specification.md`

- [ ] **Add New Section** - Vehicle Operations Endpoints (insert after GET /api/vehicles section)
  ```markdown
  ### POST /api/vehicles/:id/translate

  Trigger on-demand translation for a specific vehicle.

  **Source:** Story 2.4c (lines 489-503)

  **Request:**
  - **Method:** POST
  - **URL:** `/api/vehicles/:id/translate`
  - **Path Parameters:**
    - `id` (string, required): Vehicle ID
  - **Query Parameters:**
    - `force` (boolean, optional): If `true`, re-translate even if already translated. Default: `false`

  **Response:**
  - **Success (202 Accepted):**
    ```json
    {
      "id": "abc123",
      "description": "Translated description text...",
      "features": ["Air Conditioning", "ABS", ...],
      "status": "new",
      ...
    }
    ```
  - **Error (404 Not Found):**
    ```json
    { "error": "Vehicle not found" }
    ```
  - **Error (500 Server Error):**
    ```json
    { "error": "Translation failed" }
    ```

  **Use Cases:**
  - Force re-translation of vehicle marked as `'not_interested'`
  - Retry translation after failure
  - Update translation with new AI model

  **Notes:**
  - Executes VehicleTranslator programmatically (not via child process)
  - Respects 15 RPM rate limit (4s delay between vehicles)
  - Returns 202 Accepted (async operation, but waits for completion)

  ---

  ### POST /api/vehicles/:id/analyze

  Trigger on-demand AI analysis for a specific vehicle.

  **Source:** Story 2.4c (lines 505-520)

  **Request:**
  - **Method:** POST
  - **URL:** `/api/vehicles/:id/analyze`
  - **Path Parameters:**
    - `id` (string, required): Vehicle ID
  - **Query Parameters:**
    - `force` (boolean, optional): If `true`, re-analyze all steps. Default: `false`

  **Response:**
  - **Success (202 Accepted):**
    ```json
    {
      "id": "abc123",
      "personalFitScore": 85,
      "marketValueScore": "-5%",
      "aiPriorityRating": 90,
      "aiPrioritySummary": "Excellent match...",
      "aiMechanicReport": "Recommended checks...",
      "aiDataSanityCheck": "...",
      ...
    }
    ```
  - **Error (404 Not Found):**
    ```json
    { "error": "Vehicle not found" }
    ```
  - **Error (500 Server Error):**
    ```json
    { "error": "Analysis failed" }
    ```

  **Use Cases:**
  - Force re-analysis after user updates search criteria
  - Retry analysis after failure
  - Update analysis with new AI model

  **Notes:**
  - Assumes vehicle is already translated (description not null)
  - Executes VehicleAnalyzer programmatically (not via child process)
  - Respects 15 RPM rate limit (4s delay between vehicles)
  - Returns 202 Accepted (async operation, but waits for completion)
  ```

---

#### ðŸ“„ CHANGELOG.md

**File:** `docs/architecture/CHANGELOG.md`

- [ ] **Add Entry** - Document Story 2.4c architectural changes
  ```markdown
  ## [Unreleased]

  ### Added - Story 2.4c (Translation Extraction & Pipeline Optimization)
  - **New Vehicle Status:** Added `'not_interested'` to VehicleStatus enum for automatic filtering
  - **Translation Pipeline:** Extracted translation into standalone `translate.ts` script
  - **Feature Filtering:** Vehicles without required features automatically marked as `'not_interested'` during translation
  - **API Endpoints:** Added POST /api/vehicles/:id/translate and POST /api/vehicles/:id/analyze for on-demand operations
  - **Force Flag:** Both translation and analysis scripts support `--force` flag to bypass filters
  - **Two-Step Workflow:** Analysis now assumes pre-translation (translate â†’ analyze pipeline)

  ### Changed - Story 2.4c
  - **AIService:** Now accepts optional model parameter for per-operation model selection
  - **VehicleRepository:** Added `findVehiclesNeedingTranslation()` method with status filtering
  - **Filtering Logic:** Feature matching now checks `sourceEquipment` (Polish) BEFORE translation
  - **Rate Limiting:** Optimized to skip delay when vehicles filtered (no AI call made)

  ### Fixed - Story 2.4c
  - Database constraint updated to include `'not_interested'` status value
  - Description and features fields now properly saved to database
  - Filtered vehicles no longer re-queried in subsequent translation runs
  ```

---

### 3. PRD Documentation

**File:** `docs/prd/epic-2-ai-insights-interactive-ui.md`

- [ ] **Review Story 2.5 Section** - Ensure it reflects new UI action buttons requirement
- [ ] **No Changes Required** - Story 2.4c is implementation optimization, doesn't change product requirements

---

## ðŸ”„ Implementation Order

### Phase 1: Documentation Updates (Before Story 2.5 Development)
**Priority: HIGH - Blocking Story 2.5**

1. âœ… Update Story 2.5 with all task additions (lines 27, 42, 47, 48-56, 258, 299)
2. âœ… Update data-models.md line 12 (VehicleStatus enum)
3. âœ… Update core-workflows.md with Translation workflow section

**Estimated Time:** 30-45 minutes

---

### Phase 2: Story 2.5 Implementation (Code Development)
**Priority: HIGH - Active Development**

**Implementation Order:**
1. Add API client functions (lib/api.ts)
2. Update VehicleContext with action functions
3. Add action buttons to VehicleCard component
4. Add loading/error states and confirmation dialogs
5. Write tests for new functionality

**Estimated Time:** 3-4 hours

---

### Phase 3: Architecture Documentation Completion (Post-Implementation)
**Priority: MEDIUM - Documentation Hygiene**

1. Update api-specification.md with new endpoints
2. Update architecture CHANGELOG.md with Story 2.4c changes
3. Verify all cross-references are consistent

**Estimated Time:** 30 minutes

---

## âœ… Verification Checklist

### Story 2.5 Readiness
- [ ] Story 2.5 includes `'not_interested'` status in all relevant places
- [ ] Story 2.5 includes vehicle action buttons task
- [ ] Story 2.5 includes API client functions task
- [ ] Story 2.5 includes VehicleContext enhancement task
- [ ] Story 2.5 test requirements updated with new API tests
- [ ] Story 2.5 Dev Notes include API integration examples

### Architecture Documentation
- [ ] data-models.md reflects new VehicleStatus enum
- [ ] core-workflows.md includes Translation workflow diagram
- [ ] core-workflows.md renumbers workflows correctly (2â†’3, 3â†’4)
- [ ] api-specification.md documents new POST endpoints
- [ ] CHANGELOG.md documents Story 2.4c architectural changes

### Code Verification (Post-Implementation)
- [ ] VehicleCard displays action buttons for appropriate vehicles
- [ ] Force Translate button calls correct API endpoint
- [ ] Force Analyze button calls correct API endpoint
- [ ] Loading states work correctly
- [ ] Error handling displays user-friendly messages
- [ ] Confirmation dialogs prevent accidental operations
- [ ] Updated vehicle data reflects in dashboard after operations
- [ ] Tests cover all new functionality

---

## ðŸ“Š Impact Summary

| Document | Lines Changed | Sections Added | Priority |
|----------|---------------|----------------|----------|
| Story 2.5 | ~150 lines | 4 sections | HIGH |
| data-models.md | 2 lines | 1 note | HIGH |
| core-workflows.md | ~50 lines | 1 workflow | HIGH |
| api-specification.md | ~80 lines | 2 endpoints | MEDIUM |
| CHANGELOG.md | ~15 lines | 1 entry | LOW |

**Total Estimated Documentation Work:** 1.5-2 hours
**Total Estimated Implementation Work:** 3-4 hours
**Total Project Impact:** 4.5-6 hours

---

## ðŸš€ Next Steps

1. **Review this checklist** with team/stakeholders
2. **Update Story 2.5** with all required changes (Phase 1)
3. **Update architecture docs** (data-models, core-workflows) (Phase 1)
4. **Begin Story 2.5 implementation** once documentation is complete (Phase 2)
5. **Complete remaining docs** after implementation (Phase 3)

---

**Generated By:** John (Product Manager)
**Date:** 2025-10-14
**Source:** Story 2.4c Completion Notes & QA Review
