# <!-- Powered by BMAD™ Core -->

# Story 2.5: Card-Based Vehicle Dashboard

## Status
Draft

## Story
**As a** user,
**I want** a dashboard UI that fetches and displays all the analyzed vehicles in a card-based layout,
**so that** I can easily scan and compare all the potential vehicles.

## Acceptance Criteria
1. A dashboard page is created that fetches all vehicle data.
2. Each vehicle is rendered as a `VehicleCard` component showing key info, scores, and an interactive image carousel.
3. Basic sorting controls are added to the dashboard.

## Tasks / Subtasks
- [ ] Enhance VehicleCard component with complete data display (AC: 2)
  - [ ] Display all AI-generated scores (personalFitScore, marketValueScore, aiPriorityRating)
  - [ ] Render aiPrioritySummary prominently for quick insights
  - [ ] Add visual indicators for score quality (color coding, badges)
  - [ ] Implement interactive image carousel with navigation controls
  - [ ] Display seller information (name, location, member since)
  - [ ] Show vehicle key specs (year, mileage, price in PLN and EUR)
  - [ ] Add status badge indicator (new, to_contact, contacted, to_visit, visited, not_interested, deleted)
  - [ ] Ensure responsive horizontal card layout is maintained
  - [ ] Add proper TypeScript types for all props
- [ ] Enhance VehicleDashboard with sorting functionality (AC: 3)
  - [ ] Implement sort controls in SearchAndFilters component
  - [ ] Add sorting options: Priority (default), Price (low/high), Year, Mileage, Personal Fit Score
  - [ ] Implement client-side sorting logic for vehicle list
  - [ ] Maintain sort state in VehicleContext for persistence across navigation
  - [ ] Add visual indication of current sort order
  - [ ] Ensure sorted data displays correctly in card grid
- [ ] Verify dashboard data fetching and display (AC: 1)
  - [ ] Confirm useVehicles hook fetches all vehicles from /api/vehicles endpoint
  - [ ] Verify loading states display during data fetch
  - [ ] Verify error states display when fetch fails
  - [ ] Ensure empty state displays when no vehicles exist
  - [ ] Test with real analyzed vehicle data from database
- [ ] Update layout and styling for production-ready dashboard
  - [ ] Optimize card grid layout for desktop viewport (responsive columns)
  - [ ] Add hover effects and transitions for card interactions
  - [ ] Ensure consistent spacing and alignment across cards
  - [ ] Add proper accessibility attributes (aria-labels, semantic HTML)
  - [ ] Optimize image loading with Next.js Image component or lazy loading
- [ ] Add vehicle action buttons to VehicleCard component (AC: 2)
  - [ ] Create "Force Translate" button that calls POST /api/vehicles/:id/translate?force=true
  - [ ] Create "Force Analyze" button that calls POST /api/vehicles/:id/analyze?force=true
  - [ ] Display buttons only for vehicles with status='not_interested' or missing AI data
  - [ ] Show loading state during API call (spinner on button)
  - [ ] Handle success: Update vehicle in context with returned data
  - [ ] Handle errors: Display error message to user (toast notification)
  - [ ] Add confirmation dialog before forcing operations
  - [ ] Style buttons appropriately (secondary/ghost style, small size)
  - [ ] Add tooltips explaining what each button does
  - [ ] Ensure buttons are keyboard accessible
- [ ] Add API client functions for vehicle operations (AC: 2)
  - [ ] Add translateVehicle(vehicleId: string, force?: boolean): Promise<Vehicle> to lib/api.ts
  - [ ] Add analyzeVehicle(vehicleId: string, force?: boolean): Promise<Vehicle> to lib/api.ts
  - [ ] Both functions should POST to respective endpoints
  - [ ] Include proper error handling and HTTP status code checks
  - [ ] Return parsed Vehicle object from response
  - [ ] Add TypeScript types for request/response
- [ ] Enhance VehicleContext with action functions (AC: 2)
  - [ ] Add forceTranslateVehicle(vehicleId: string): Promise<void>
  - [ ] Add forceAnalyzeVehicle(vehicleId: string): Promise<void>
  - [ ] Both functions should call API client and update vehicles array
  - [ ] Handle loading state during operations
  - [ ] Handle error state and surface to UI
  - [ ] Emit events for success/failure (for toast notifications)
- [ ] Write comprehensive test suite
  - [ ] Unit tests for VehicleCard component with all data scenarios
  - [ ] Unit tests for action buttons (Force Translate, Force Analyze)
  - [ ] Test button visibility based on vehicle status and AI data
  - [ ] Test loading states during API calls
  - [ ] Test error handling for failed API calls
  - [ ] Unit tests for sorting logic in VehicleDashboard
  - [ ] Test image carousel navigation and rendering
  - [ ] Integration tests for dashboard data fetching and display
  - [ ] Test translateVehicle() and analyzeVehicle() API client functions
  - [ ] Test VehicleContext action functions
  - [ ] Test error handling and loading states
  - [ ] Test sorting functionality with mock vehicle data
  - [ ] Test empty state rendering
  - [ ] Verify TypeScript compilation for all components

## Dev Notes

### Previous Story Insights
From Story 2.4 (Market Value Score Service):
- **Market Value Score Format**: The marketValueScore field now contains percentage strings: "-5%" (good deal), "+10%" (overpriced), "market_avg" (at market), or null (no comparables)
- **Analysis Pipeline**: All vehicles processed through analyze.ts now have complete AI analysis data:
  - Translation (description + features)
  - Data Sanity Check (aiDataSanityCheck field)
  - Personal Fit Score (personalFitScore field, 0-100 scale)
  - Virtual Mechanic's Report (aiMechanicReport field)
  - Market Value Score (marketValueScore field) - NEW from Story 2.4
  - AI Priority Rating (aiPriorityRating field, 0-100 scale) + Summary (aiPrioritySummary field)

From Story 2.1 (Frontend Application Setup):
- **Frontend Infrastructure**: Next.js 14.2.0 app with App Router in `apps/web/`
- **Existing Components**:
  - `VehicleCard.tsx` - Basic horizontal card with image carousel (to be enhanced)
  - `VehicleDashboard.tsx` - Dashboard container with loading/error states (to be enhanced)
  - `Header.tsx` - Application header with branding
  - `SearchAndFilters.tsx` - Search/filter bar (to be enhanced with sorting)
  - `AIChatSidebar.tsx` - Toggleable AI chat sidebar
- **State Management**: VehicleContext provides global vehicle state via useVehicles hook
- **API Client**: `lib/api.ts` with fetchVehicles() function configured for localhost:3000
- **Styling**: Tailwind CSS 3.4.0 configured with PostCSS
- **UI Components**: Shadcn UI primitives available in `src/components/ui/`

### Architecture Context

#### Frontend Architecture Pattern [Source: architecture/frontend-architecture.md]
- **Component Organization**: Feature components in `src/components/`, Shadcn UI primitives in `src/components/ui/`
- **State Management**: React Context (VehicleContext) for global vehicle data, component-level useState for UI interactions (sorting)
- **Data Flow**: Unidirectional - API client → Context → Components
- **Routing**: Next.js App Router with client-side navigation for SPA feel

#### Data Models [Source: architecture/data-models.md]

**Vehicle Interface** (available in `packages/types`):
```typescript
export interface Vehicle {
  id: string;
  source: VehicleSource;
  sourceUrl: string;

  // Processed & Normalized Data
  title: string;
  description: string; // Translated, plain-text
  features: string[]; // Normalized equipment
  pricePln: number;
  priceEur: number;
  year: number;
  mileage: number;
  sellerInfo: SellerInfo;
  photos: string[]; // Cleaned URLs for carousel

  // AI Generated Data (all nullable)
  personalFitScore: number | null; // 0-100 scale
  marketValueScore: string | null; // e.g., "-5%", "+10%", "market_avg"
  aiPriorityRating: number | null; // 0-100 scale
  aiPrioritySummary: string | null; // Natural language summary
  aiMechanicReport: string | null; // Model-specific insights
  aiDataSanityCheck: string | null; // Inconsistency flags

  // User Workflow Data
  status: VehicleStatus; // 'new' | 'to_contact' | 'contacted' | 'to_visit' | 'visited' | 'deleted'
  personalNotes: string | null;

  // Timestamps
  createdAt: Date;
  updatedAt: Date;
}
```

**SellerInfo Interface**:
```typescript
export interface SellerInfo {
  name: string | null;
  id: string | null;
  type: SellerType; // 'private' | 'company' | null
  location: string | null;
  memberSince: string | null;
}
```

#### Component Specifications [Source: architecture/components.md]

**VehicleCard Component Requirements**:
- Display vehicle title, year, mileage prominently
- Show price in both PLN (primary) and EUR (secondary)
- Display all AI scores with visual indicators:
  - Personal Fit Score (0-100, color-coded)
  - Market Value Score (percentage with color: green for negative/good deal, red for positive/overpriced, gray for market_avg)
  - AI Priority Rating (0-100, color-coded)
- Render aiPrioritySummary for quick insights
- Interactive image carousel with navigation arrows and indicators
- Display seller info (name, location, type badge)
- Show vehicle status badge
- Horizontal card layout optimized for desktop
- Proper hover states and transitions

**VehicleDashboard Component Requirements**:
- Fetch vehicles via useVehicles hook from VehicleContext
- Display loading state during fetch (spinner or skeleton cards)
- Display error state if fetch fails (error message with retry button)
- Display empty state if no vehicles exist
- Render grid of VehicleCard components
- Integrate sorting controls from SearchAndFilters component
- Maintain responsive grid layout (adjust columns based on viewport)

#### File Locations [Source: architecture/source-tree.md]

**Existing Files to Modify**:
```
apps/web/src/
├── components/
│   ├── VehicleCard.tsx          # ENHANCE - Add all AI scores, improve carousel, seller info
│   ├── VehicleDashboard.tsx     # ENHANCE - Add sorting logic, improve layout
│   └── SearchAndFilters.tsx     # ENHANCE - Add sorting controls UI
├── context/
│   └── VehicleContext.tsx       # ENHANCE - Add sorting state management
└── lib/
    └── utils.ts                 # ENHANCE - Add sorting utility functions
```

**No New Files Required**: This story enhances existing components from Story 2.1.

#### Sorting Implementation Details

**Sorting Options** (in priority order):
1. **Priority (Default)**: Sort by aiPriorityRating descending (highest first), fallback to personalFitScore if null
2. **Price (Low to High)**: Sort by priceEur ascending
3. **Price (High to Low)**: Sort by priceEur descending
4. **Year (Newest First)**: Sort by year descending
5. **Year (Oldest First)**: Sort by year ascending
6. **Mileage (Lowest First)**: Sort by mileage ascending
7. **Mileage (Highest First)**: Sort by mileage descending
8. **Personal Fit Score**: Sort by personalFitScore descending (highest first)

**Sorting State Management**:
- Store current sort option in VehicleContext (e.g., `sortBy: 'priority' | 'price_asc' | 'price_desc' | ...`)
- Expose `setSortBy()` function from context for components to update sort
- Apply sorting in VehicleDashboard component before rendering cards
- Sorting is client-side (no API changes needed - all data already fetched)

**Sorting Utility Function** (add to `lib/utils.ts`):
```typescript
export function sortVehicles(vehicles: Vehicle[], sortBy: SortOption): Vehicle[] {
  const sorted = [...vehicles]; // Create copy to avoid mutation

  switch (sortBy) {
    case 'priority':
      return sorted.sort((a, b) =>
        (b.aiPriorityRating ?? b.personalFitScore ?? 0) -
        (a.aiPriorityRating ?? a.personalFitScore ?? 0)
      );
    case 'price_asc':
      return sorted.sort((a, b) => a.priceEur - b.priceEur);
    case 'price_desc':
      return sorted.sort((a, b) => b.priceEur - a.priceEur);
    case 'year_desc':
      return sorted.sort((a, b) => b.year - a.year);
    case 'year_asc':
      return sorted.sort((a, b) => a.year - b.year);
    case 'mileage_asc':
      return sorted.sort((a, b) => a.mileage - b.mileage);
    case 'mileage_desc':
      return sorted.sort((a, b) => b.mileage - a.mileage);
    case 'personal_fit':
      return sorted.sort((a, b) => (b.personalFitScore ?? 0) - (a.personalFitScore ?? 0));
    default:
      return sorted;
  }
}
```

#### UI/UX Guidelines [Source: PRD via Story 2.1]

**Design Goals**:
- **Overall UX**: Powerful, data-rich analysis tool with "mission control" dashboard aesthetic
- **Target Device**: Desktop/laptop browser (responsive, but optimized for larger screens)
- **Aesthetic**: Clean, minimalist, "data-tool" aesthetic (consider dark mode theme)
- **Fast Navigation**: SPA feel with near-instant transitions
- **Data Display**: Complex information presented in clean, scannable, actionable format

**Card Layout Considerations**:
- Horizontal card layout (already implemented in Story 2.1, maintain consistency)
- Image carousel on left side of card
- Vehicle info and scores on right side
- Clear visual hierarchy: Title → Scores → Specs → Seller Info
- Color coding for scores (green = good, red = bad, yellow = neutral)
- Hover effects for interactivity (scale, shadow, border highlight)

#### API Integration [Source: architecture/api-specification.md]

**GET /api/vehicles Endpoint** (already implemented in Story 2.1):
- **URL**: `http://localhost:3000/api/vehicles`
- **Method**: GET
- **Response**: 200 OK with JSON array of Vehicle objects
- **Frontend Integration**: Accessed via `fetchVehicles()` in `lib/api.ts`
- **State Management**: Data cached in VehicleContext, accessed via `useVehicles()` hook

**No API Changes Required**: This story is purely frontend enhancements using existing data.

#### Vehicle Operations API [Source: Story 2.4c lines 489-520]

**POST /api/vehicles/:id/translate Endpoint**:
- **URL**: `http://localhost:3000/api/vehicles/:id/translate?force=true`
- **Method**: POST
- **Query Parameters**:
  - `force` (optional): boolean - If true, re-translate even if already translated
- **Response**: 202 Accepted with updated Vehicle JSON
- **Error Codes**: 404 Not Found, 500 Server Error
- **Use Case**: Force re-translation of a vehicle (e.g., if translation was incomplete or 'not_interested' status needs reversal)

**POST /api/vehicles/:id/analyze Endpoint**:
- **URL**: `http://localhost:3000/api/vehicles/:id/analyze?force=true`
- **Method**: POST
- **Query Parameters**:
  - `force` (optional): boolean - If true, re-analyze all steps
- **Response**: 202 Accepted with updated Vehicle JSON
- **Error Codes**: 404 Not Found, 500 Server Error
- **Use Case**: Force re-analysis of a vehicle (e.g., after user updates criteria or if analysis incomplete)

**Frontend Integration Pattern**:
```typescript
// In lib/api.ts
export async function translateVehicle(vehicleId: string, force: boolean = false): Promise<Vehicle> {
  const url = `${API_BASE_URL}/vehicles/${vehicleId}/translate${force ? '?force=true' : ''}`;
  const response = await fetch(url, { method: 'POST' });

  if (!response.ok) {
    if (response.status === 404) throw new Error('Vehicle not found');
    throw new Error('Translation failed');
  }

  return await response.json();
}

export async function analyzeVehicle(vehicleId: string, force: boolean = false): Promise<Vehicle> {
  const url = `${API_BASE_URL}/vehicles/${vehicleId}/analyze${force ? '?force=true' : ''}`;
  const response = await fetch(url, { method: 'POST' });

  if (!response.ok) {
    if (response.status === 404) throw new Error('Vehicle not found');
    throw new Error('Analysis failed');
  }

  return await response.json();
}
```

**UI Integration Example** (VehicleCard component):
```tsx
import { useVehicles } from '@/context/VehicleContext';
import { translateVehicle, analyzeVehicle } from '@/lib/api';
import { useState } from 'react';

function VehicleCard({ vehicle }: VehicleCardProps) {
  const { updateVehicle } = useVehicles();
  const [isTranslating, setIsTranslating] = useState(false);
  const [isAnalyzing, setIsAnalyzing] = useState(false);

  const handleForceTranslate = async () => {
    if (!confirm('Force re-translate this vehicle? This will use AI credits.')) return;

    try {
      setIsTranslating(true);
      const updatedVehicle = await translateVehicle(vehicle.id, true);
      updateVehicle(updatedVehicle);
      toast.success('Vehicle translated successfully');
    } catch (error) {
      toast.error('Translation failed: ' + error.message);
    } finally {
      setIsTranslating(false);
    }
  };

  const handleForceAnalyze = async () => {
    if (!confirm('Force re-analyze this vehicle? This will use AI credits.')) return;

    try {
      setIsAnalyzing(true);
      const updatedVehicle = await analyzeVehicle(vehicle.id, true);
      updateVehicle(updatedVehicle);
      toast.success('Vehicle analyzed successfully');
    } catch (error) {
      toast.error('Analysis failed: ' + error.message);
    } finally {
      setIsAnalyzing(false);
    }
  };

  // Show action buttons for not_interested or incomplete AI data
  const showActions = vehicle.status === 'not_interested' ||
                      !vehicle.description ||
                      !vehicle.aiPriorityRating;

  return (
    <div className="vehicle-card">
      {/* ... existing card content ... */}

      {showActions && (
        <div className="card-actions">
          <Button
            size="sm"
            variant="ghost"
            onClick={handleForceTranslate}
            disabled={isTranslating}
          >
            {isTranslating ? 'Translating...' : 'Force Translate'}
          </Button>
          <Button
            size="sm"
            variant="ghost"
            onClick={handleForceAnalyze}
            disabled={isAnalyzing}
          >
            {isAnalyzing ? 'Analyzing...' : 'Force Analyze'}
          </Button>
        </div>
      )}
    </div>
  );
}
```

#### Technical Constraints [Source: architecture/tech-stack.md, architecture/coding-standards.md]

**Technology Stack**:
- **Next.js**: ~14.2.0 with App Router
- **React**: ~18.3.0 with hooks and context
- **Tailwind CSS**: ~3.4.0 for styling
- **TypeScript**: ~5.5.0 with strict mode
- **Shadcn UI**: Available primitives for consistent UI

**Coding Standards**:
- **Components**: PascalCase file names (`VehicleCard.tsx`)
- **Functions**: camelCase (`sortVehicles`, `getScoreColor`)
- **Types**: PascalCase (`SortOption`, `VehicleCardProps`)
- **Props Interfaces**: ComponentNameProps pattern (`VehicleCardProps`)
- **Import Order**: React/Next → Third-party → Internal packages → Relative imports
- **Type Safety**: Explicit return types, no `any` types, strict null checks

**File Organization**:
- Components in `src/components/`
- Context providers in `src/context/`
- Utility functions in `src/lib/`
- Types can be co-located or in `src/lib/types.ts`

### Testing

#### Testing Standards [Source: architecture/testing-strategy.md]
- **Framework**: Jest ~29.7.0 with React Testing Library for component tests
- **File Location**: Co-located `*.test.tsx` files next to components
- **Coverage Goal**: Focus on critical paths and complex logic (sorting, data display)
- **Mocking Strategy**: Mock API client and context providers for unit tests

#### Testing Requirements for This Story

**VehicleCard Component Tests** (`src/components/VehicleCard.test.tsx`):
- Test rendering with complete vehicle data (all scores populated)
- Test rendering with partial data (some scores null)
- Test rendering with no AI data (all scores null)
- Test image carousel navigation (next/prev buttons, indicators)
- Test score color coding (personal fit, market value, priority rating)
- Test status badge rendering for all VehicleStatus values (including 'not_interested')
- Test seller info display (name, location, type)
- Test price formatting (PLN primary, EUR secondary)
- Test hover states and interactions
- Test responsive layout behavior

**VehicleDashboard Component Tests** (`src/components/VehicleDashboard.test.tsx`):
- Test loading state displays during data fetch
- Test error state displays when fetch fails
- Test empty state displays when no vehicles
- Test vehicle cards render correctly with fetched data
- Test sorting functionality for each sort option
- Test sort state persists across component re-renders
- Test grid layout responsiveness
- Mock VehicleContext for controlled test scenarios

**Sorting Logic Tests** (`src/lib/utils.test.ts`):
- Test sortVehicles() function with all sort options
- Test priority sort with null values (fallback to personalFitScore)
- Test price sorting (ascending and descending)
- Test year sorting (newest and oldest first)
- Test mileage sorting (lowest and highest first)
- Test personal fit score sorting
- Test sorting with empty array
- Test sorting doesn't mutate original array

**SearchAndFilters Component Tests** (`src/components/SearchAndFilters.test.tsx`):
- Test sort dropdown renders all sort options
- Test selecting sort option updates context state
- Test active sort option is visually indicated
- Test sort controls are keyboard accessible

**Integration Tests** (`src/__tests__/dashboard-integration.test.tsx`):
- Test full dashboard flow: fetch → display → sort → update
- Test error recovery (retry button on error state)
- Test navigation from dashboard to vehicle detail (if implemented)
- Mock API responses for controlled test scenarios

**Test Coverage Goals**:
- Aim for >80% coverage for sorting logic (critical business logic)
- 100% coverage for all sort options in sortVehicles() function
- Test all edge cases (null values, empty arrays, missing data)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| Oct 10, 2025 | 1.0 | Initial story creation for Epic 2, Story 2.5 - Card-Based Vehicle Dashboard | Bob (SM) |

## Dev Agent Record

### Agent Model Used
*To be populated by Dev Agent*

### Debug Log References
*To be populated by Dev Agent*

### Completion Notes
*To be populated by Dev Agent*

### File List
*To be populated by Dev Agent*

## QA Results
*Results from QA Agent review will be populated here after story completion*
